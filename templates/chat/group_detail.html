{% extends 'base.html' %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="flex flex-col md:flex-row h-[calc(100vh-5rem)] gap-4 p-2 md:p-0">
    <!-- Main Chat Area -->
    <div class="flex-1 bg-white rounded-lg shadow-md flex flex-col order-2 md:order-1">
        <!-- Group Header -->
        <div class="p-3 md:p-4 border-b flex justify-between items-center">
            <div>
                <h1 class="text-lg md:text-xl font-semibold text-gray-800">{{ group.name }}</h1>
                <p class="text-xs md:text-sm text-gray-600">{{ group.description }}</p>
            </div>
            <button id="refresh-button" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-2 md:p-4 space-y-3 md:space-y-4">
            {% for message in messages %}
            <div class="flex {% if message.sender == request.user %}justify-end{% endif %}">
                <div class="max-w-[85%] md:max-w-[70%] {% if message.sender == request.user %}bg-blue-100{% else %}bg-gray-100{% endif %} rounded-lg p-2 md:p-3">
                    <div class="flex items-center gap-1 md:gap-2 mb-1">
                        <div class="w-5 h-5 md:w-6 md:h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs">
                            {{ message.sender.username|first|upper }}
                        </div>
                        <div class="text-xs md:text-sm text-gray-600">{{ message.sender.username }}</div>
                    </div>
                    {% if message.content %}
                        <div class="text-sm md:text-base text-gray-800">{{ message.content }}</div>
                    {% endif %}
                    {% if message.chatattachment_set.exists %}
                        {% for attachment in message.chatattachment_set.all %}
                            <div class="mt-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                </svg>
                                <a href="{{ attachment.file.url }}" 
                                   class="text-blue-600 hover:text-blue-800 text-sm underline"
                                   target="_blank">
                                    Download Attachment
                                </a>
                            </div>
                        {% endfor %}
                    {% endif %}
                    <div class="text-[10px] md:text-xs text-gray-500 mt-1">{{ message.timestamp|date:"M d, Y g:i A" }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- Message Input -->
        <div class="p-2 md:p-4 border-t">
            <!-- Text Message Form -->
            <form id="message-form" class="mb-2">
                {% csrf_token %}
                <div class="flex gap-2">
                    <input type="text" 
                            id="message-input"
                            name="message" 
                            class="flex-1 px-3 md:px-4 py-2 text-sm md:text-base rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="Type your message..."
                            autocomplete="off">
                    <button type="submit" 
                            class="px-4 md:px-6 py-2 bg-blue-600 text-white text-sm md:text-base rounded-full hover:bg-blue-700 transition duration-300">
                        Send
                    </button>
                </div>
            </form>

            <!-- File Upload Form -->
            <form id="file-form" class="flex items-center gap-2">
                {% csrf_token %}
                <label for="file-upload" class="cursor-pointer">
                    <svg class="w-6 h-6 text-gray-500 hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                    </svg>
                </label>
                {{ attachment_form.file }}
                <span id="file-name" class="text-sm text-gray-500"></span>
                <button type="submit" 
                        class="px-3 py-1 bg-green-600 text-white text-sm rounded-full hover:bg-green-700 transition duration-300">
                    Upload
                </button>
            </form>
        </div>
    </div>

    <!-- Members Sidebar -->
    <div class="w-full md:w-64 bg-white rounded-lg shadow-md p-3 md:p-4 order-1 md:order-2 mb-4 md:mb-0">
        <h2 class="text-base md:text-lg font-semibold mb-3 md:mb-4 text-gray-800">Members ({{ members.count }})</h2>
        <div class="flex flex-row md:flex-col flex-wrap gap-2 md:space-y-2">
            {% for member in members %}
            <div class="flex items-center gap-2 p-2 {% if member == group.created_by %}bg-blue-50{% endif %} rounded-lg flex-grow md:flex-grow-0">
                <div class="w-6 h-6 md:w-8 md:h-8 bg-gray-200 rounded-full flex items-center justify-center text-xs">
                    {{ member.username|first|upper }}
                </div>
                <div>
                    <div class="text-xs md:text-sm font-medium">{{ member.username }}</div>
                    {% if member == group.created_by %}
                    <div class="text-[10px] md:text-xs text-blue-600">Group Admin</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        const chatMessages = $('#chat-messages');
        const messageForm = $('#chat-form');
        const messageInput = $('#message-input');
        const fileInput = $('input[type="file"]');
        const fileNameDisplay = $('#file-name');
        const groupId = {{ group.id }};
        const refreshButton = $('#refresh-button');
        let lastMessageId = null;

        fileInput.on('change', function() {
            const fileName = this.files[0]?.name || '';
            fileNameDisplay.text(fileName);
        });

        function scrollToBottom() {
            chatMessages.scrollTop(chatMessages[0].scrollHeight);
        }

        function startSpinAnimation() {
            refreshButton.addClass('animate-spin');
        }

        function stopSpinAnimation() {
            refreshButton.removeClass('animate-spin');
        }

        function fetchNewMessages() {
            $.ajax({
                url: `/api/get_messages/${groupId}/`,
                type: 'GET',
                data: { last_message_id: lastMessageId },
                success: function(response) {
                    if (response.messages && response.messages.length > 0) {
                        response.messages.forEach(msg => {
                            const isCurrentUser = msg.sender_username === '{{ request.user.username }}';
                            addMessageToChat(msg.content, msg.sender_username, isCurrentUser, msg.attachment_url);
                            lastMessageId = msg.id;
                        });
                        scrollToBottom();
                    }
                    stopSpinAnimation();
                },
                error: function() {
                    stopSpinAnimation();
                }
            });
        }

        refreshButton.on('click', function() {
            startSpinAnimation();
            fetchNewMessages();
            setTimeout(stopSpinAnimation, 1000);
        });

        function addMessageToChat(message, username, isCurrentUser = true, attachment = null) {
            const currentTime = new Date().toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            });

            let messageContent = '';
            if (message) {
                messageContent = `<div class="text-gray-800">${message}</div>`;
            }

            let attachmentHtml = '';
            if (attachment) {
                attachmentHtml = `
                    <div class="mt-2 flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                        </svg>
                        <a href="${attachment}" class="text-blue-600 hover:text-blue-800 text-sm underline" target="_blank">
                            Download Attachment
                        </a>
                    </div>
                `;
            }

            const messageHtml = `
                <div class="flex ${isCurrentUser ? 'justify-end' : ''}">
                    <div class="max-w-[70%] ${isCurrentUser ? 'bg-blue-100' : 'bg-gray-100'} rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center text-xs">
                                ${username.charAt(0).toUpperCase()}
                            </div>
                            <div class="text-sm text-gray-600">${username}</div>
                        </div>
                        ${messageContent}
                        ${attachmentHtml}
                        <div class="text-xs text-gray-500 mt-1">${currentTime}</div>
                    </div>
                </div>
            `;
            chatMessages.append(messageHtml);
            scrollToBottom();
        }
        // Message form handling
        $('#message-form').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const message = $('#message-input').val().trim();
            
            if (!message) return;
            
            $.ajax({
                url: `/api/send_message/${groupId}/`,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $('#message-input').val('');
                    addMessageToChat(message, '{{ request.user.username }}', true);
                    lastMessageId = response.message_id;
                }
            });
        });

        // File form handling
        $('#file-form').on('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const file = $('input[type="file"]')[0].files[0];
            
            if (!file) return;
            
            $.ajax({
                url: `/api/send_message/${groupId}/`,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $('input[type="file"]').val('');
                    $('#file-name').text('');
                    addMessageToChat('Shared an attachment', '{{ request.user.username }}', true, response.attachment_url);
                    lastMessageId = response.message_id;
                }
            });
        });
        setInterval(fetchNewMessages, 2000);
        fetchNewMessages();
        messageInput.focus();
    });
</script>
{% endblock %}
